#!/bin/bash

queue=$(qstat -Q | tail -n +3 | awk '{print $1}')
nodect=$(qmgr -c "list queue $queue" | awk '/nodect/{print $3}')

period=${1:-30}
resched_num=$((nodect*2))
regex=Q

main (){
    echo "[$(date)] picking $resched_num jobs"

    jobs=$(qgrep $regex | head -n $resched_num)

    echo "[$(date)] holding"

    qhold $jobs

    echo "[$(date)] rescheduling"

    qrls $jobs

    echo "[$(date)] sleep $period"

    sleep $period
}

while :
do
    main
done

