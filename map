#!/bin/bash
#-*- mode:sh -*-

PARALLEL=false
SUDO=false
SUDO_PASSWORD=
VERBOSE=true
while getopts ":qps:" opt
do
    case ${opt} in
        p)  PARALLEL=true ;
            echo "Invoking ssh in parallel."
            ;;
        q)  VERBOSE=false ;;
        s)  SUDO=true ;
            SUDO_PASSWORD=${OPTARG}
            echo "Enabling sudo."
            ;;
        \?) OPT_ERROR=1; break;;
        * ) echo "unsupported option $opt" ;;
    esac
done

shift $(($OPTIND - 1))

hosts=$(cat $(dirname $0)/hosts | sed -e "s/#.*//g")
commands=$@
ssh_option="-q"
if $SUDO
then
    commands="echo $SUDO_PASSWORD | sudo -S -p \"\" -- sh -c \"$commands\""
fi
$VERBOSE && echo "Running command: $commands"
$VERBOSE && ssh_option=""
$PARALLEL && ssh_option="-t $ssh_option"

run (){
    ssh $ssh_option $host "cd $PWD; $commands"
}

for host in $hosts
do
    $VERBOSE && echo "logging in to $host..."
    if $PARALLEL
    then
        run &
    else
        run
    fi
done



wait
