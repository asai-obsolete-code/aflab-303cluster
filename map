#!/bin/bash
#-*- mode:sh -*-

PARALLEL=false
SUDO=false
SUDO_PASSWORD=
LUCY=false
while getopts ":qpl-s:" opt
do
    case ${opt} in
        p)  PARALLEL=true ;
            echo "Invoking ssh in parallel."
            ;;
        l)  LUCY=true ;;
        s)  SUDO=true ;
            SUDO_PASSWORD=${OPTARG}
            echo "Enabling sudo."
            ;;
        -)  break ;;
        \?) OPT_ERROR=1; break;;
        * ) echo "unsupported option $opt" ;;
    esac
done

shift $(($OPTIND - 1))

acc=

while [[ $# != "0" && $1 != "--" ]]
do
    acc="$acc $1"
    shift
done

if [[ $1 == "--" ]]
then
    shift
    ssh_option="$acc"
    commands=$@
else
    ssh_option=""
    commands="$acc"
fi

hosts=$(cat $(dirname $0)/hosts | sed -e "s/#.*//g")

$LUCY && hosts="funlucy $hosts"
$SUDO && commands="echo $SUDO_PASSWORD | sudo -S -p \"\" -- sh -c \"$commands\""
$PARALLEL && ssh_option="-t $ssh_option"

echo "Running command: $commands"
echo "SSH options: $ssh_option"
echo "Final command to run: ssh $ssh_option -- <host> \"cd $PWD; $commands\""

run (){
    ssh $ssh_option -- $host "cd $PWD; $commands"
}

# trap definition

handle (){
    echo aborting... killing all subprocesses
    for child in $(pgrep -P $$)
    do
        kill -s $1 $child
    done
    exit
}

for signal in sighup sigtrap sigint sigterm sigxcpu sigabrt
do
    trap "handle $signal" $signal
done

for host in $hosts
do
    echo "logging in to $host..."
    if $PARALLEL
    then
        run &
    else
        run
    fi
done

wait
